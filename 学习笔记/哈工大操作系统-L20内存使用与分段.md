# 哈工大操作系统-L20内存使用与分段

[TOC]

从直观的内存应该如何的使用，再到如何科学合理的使用内存

## 1.内存如何使用

- 计算机工作的简单原理
  - 内存使用：将程序放到内存中，PC指向执行序列所在的内存的开始地址
  - 简单来说，我们只需要把程序加载到内存中就行了
- 但是会有什么问题呢？

### 问题：单纯搬移程序，绝对地址会引起内存地址的冲突

<img src="E:\AAAAAAAuniPPT\4_1PPT\CSclass-OS(git)\学习笔记\${图片}\image-20210808104511130.png" alt="image-20210808104511130" style="zoom:50%;" />

- 硬生生的搬移需要将上面这个程序放到0地址处，然后call40才能正确的执行，但是0地址放的是系统
- 科学的搬移应该是，在内存中找一段空闲的，搬入程序。
- 但是这样的话，call的40就不能是绝对地址了，因此需要处理

## 2.重定位--产生逻辑地址和物理地址的映射

- 我们称程序中写死的地址为**逻辑地址**。

- 程序中写死的地址其实是相对于程序段本身而言的。因此，把程序段中的地址认为是**相对地址**

- **重定位**：修改程序中的地址，把地址由相对地址，修改为程序中的物理地址

  - 即如果上面的程序放入的是1000处，那么call40只需要改为1040就行。

  
### 两种一般情况的重定位 

- 两种一般情况的重定位：
  - **编译时重定位**：只能**载入到固定的地方**，即编译时已经设置好的偏移(要保证那个固定的地方一定是空闲比较难)
  - **载入时重定位**：载入之前任选位置，**一旦载入**，偏移也就是固定的，**程序也不能再移动了**(如果加入的程序多了，可能内存空间也不够)

<img src="E:\AAAAAAAuniPPT\4_1PPT\CSclass-OS(git)\学习笔记\${图片}\image-20210808105118812.png" alt="image-20210808105118812" style="zoom:50%;" />

## 3.交换--将长期阻塞的进程换出内存，节省内存空间

<img src="E:\AAAAAAAuniPPT\4_1PPT\CSclass-OS(git)\学习笔记\${图片}\image-20210808105818229.png" alt="image-20210808105818229" style="zoom:50%;" />

- 交换表面，程序在载入之后，内存位置也有可能发生移动
- 因此，载入/编译时重定位都不行

## 4.重定位最佳时机--运行时重定位

- 运行每条指令时，才对每条指令上的地址执行重定位
  - 从逻辑地址算出物理地址的过程，叫**地址翻译**。基地址+偏移
  - 基地址存在PCB中
- 这样无论程序何时被换出，换入之后再执行指令，指令中含有的地址都是对的

<img src="E:\AAAAAAAuniPPT\4_1PPT\CSclass-OS(git)\学习笔记\${图片}\image-20210808110058516.png" alt="image-20210808110058516" style="zoom:50%;" />

<img src="E:\AAAAAAAuniPPT\4_1PPT\CSclass-OS(git)\学习笔记\${图片}\image-20210808110720579.png" alt="image-20210808110720579" style="zoom:50%;" />

## 5.分段

通常的程序都是分段的，程序中的地址其实是基于段的偏移。

<img src="E:\AAAAAAAuniPPT\4_1PPT\CSclass-OS(git)\学习笔记\${图片}\image-20210808111215311.png" alt="image-20210808111215311" style="zoom:50%;" />

- 分段放入内存的好处：更高效的利用内存
  - 不会增长的程序段，可以固定放在一些区域
  - 会增长的程度段，如果放置的内存区域不够了，需要移动这个段到其他区域
    - 如果整个程序放入内存的话，由于增长导致内存区域不够需要移动整个程序

### 段表

<img src="E:\AAAAAAAuniPPT\4_1PPT\CSclass-OS(git)\学习笔记\${图片}\image-20210808112000791.png" alt="image-20210808112000791" style="zoom:50%;" />

<img src="E:\AAAAAAAuniPPT\4_1PPT\CSclass-OS(git)\学习笔记\${图片}\image-20210808112311808.png" alt="image-20210808112311808" style="zoom:50%;" />

- **LDT表**：因为是分段的，因此我们需要一个**段表**去查段基址。
- GDT表可以视为是LDT表的特例，GDT表是操作系统的LDT表。