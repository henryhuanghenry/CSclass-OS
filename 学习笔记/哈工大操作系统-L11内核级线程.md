# 哈工大操作系统-L11内核级线程

[TOC]



- **没有用户级进程，进程都是需要访问内核的。**
- **线程可以分用户级和内核级。**理解用户级线程对理解内核级线程有很大帮助。
- 多内核级线程可以利用充分利用多核CPU的特性。(进程不行，用户级线程也不行)



## 1.和用户级相比，核心级线程有什么不同？

- 需要两套栈，内核栈和用户栈

  - 因为内核级线程由系统调用创建，由内核负责切换，因此会有存在内核中的内核栈
  - 而代码依然是用户态中执行的，因此也要有一个用户栈

- 内核级线程切换的时候，内核栈完成切换的同时用户栈也要进行切换

  <img src="E:\AAAAAAAuniPPT\4_1PPT\CSclass-OS(git)\学习笔记\${图片}\image-20210805172005864.png" alt="image-20210805172005864" style="zoom:50%;" />

即从上图可以知道，在中断开始后，内核栈会保存指向用户栈的指针，以及其他必要信息。

## 2.内核级线程如何切换

- 真正要执行的大多都是用户的程序，但**两个内核级线程切换需要在内核走一遭**。
- 通过系统支持的内核线程切换，**从用户到内核到内核再到用户**。
- **找到内核级线程TCB需要进入内核**

### 2.1 内核线程A的用户程序-转向-内核线程A的内核程序:用户栈到内核栈的转换

<img src="E:\AAAAAAAuniPPT\4_1PPT\CSclass-OS(git)\学习笔记\${图片}\image-20210805172237557.png" alt="image-20210805172237557" style="zoom:50%;" />

- 执行到300的时候，INT中断后，注意栈的切换动作。
- 执行完中断处理的所有程序之后(即1000那些也执行完毕)，从中断返回的时候，会弹出CS和PC，即返回到304处继续下面的执行。而内核栈上方的东西是帮助寻找用户栈的。

### 2.2 内核线程A内核程序-转向-内核线程B的内核程序:切换内核栈

<img src="E:\AAAAAAAuniPPT\4_1PPT\CSclass-OS(git)\学习笔记\${图片}\image-20210805172640316.png" alt="image-20210805172640316" style="zoom:50%;" />

- 切换前，先将当前的esp即当前的栈地址等信息保存在当前线程的TCB中
- 然后，通过切换目标内核线程的TCB知道目标的内核栈的指针，切换到另一个内核线程

### 2.3 内核线程B内核程序-转向-内核线程B的用户程序

从B线程的内核程序，通过内核栈中保存的CS和PC切回到B线程的用户程序



<img src="E:\AAAAAAAuniPPT\4_1PPT\CSclass-OS(git)\学习笔记\${图片}\image-20210805175320035.png" alt="image-20210805175320035" style="zoom:50%;" />

### 2.4 内核级线程切换的五段论

<img src="E:\AAAAAAAuniPPT\4_1PPT\CSclass-OS(git)\学习笔记\${图片}\image-20210805180128875.png" alt="image-20210805180128875" style="zoom:50%;" />

## 3.用户级线程和内核级线程的对比

<img src="E:\AAAAAAAuniPPT\4_1PPT\CSclass-OS(git)\学习笔记\${图片}\image-20210805180407276.png" alt="image-20210805180407276" style="zoom:50%;" />